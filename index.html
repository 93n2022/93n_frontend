<!DOCTYPE html>
<html>
  <head>
    <title>93N</title>
    <script src="https://aloycwl.github.io/js/cdn/jquery.min.js"></script>
    <script src="https://aloycwl.github.io/js/cdn/web3.min.js"></script>
    <script src="https://aloycwl.github.io/js/cdn/web3ac.js"></script>
    <style>
      .hide {
        display: none;
      }
      a {
        cursor: pointer;
        color: blue;
        text-decoration: underline;
      }
      input {
        width: 350px;
        cursor: pointer;
        background-color: #eeeeee;
      }
      i {
        font-size: small;
      }
      .text {
        cursor: default;
        color: black;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <a id="connect" onclick="connect()">Connect</a>
    <div id="root" class="hide">
      <h1>Part 1</h1>
      <ol>
        <li><i id="status">Status...</i></li>
        <li>Connect to Rinkeby Test Network</li>
        <li>
          Get test token from faucet as gas fee -
          <a href="https://rinkebyfaucet.com/" target="_blank">Here</a>
        </li>
        <li>
          Claim MOCK-USDT to deposit -
          <a onclick="claim()">Here</a>
        </li>
        <li>Your USDT Token: <span id="txtUSDT"></span></li>
        <li>Your 93N Token: <span id="txt93N"></span></li>
      </ol>
      <h1>Part 2</h1>
      <ol>
        <li>Referred by: <span id="txtRB"></span></li>
        <li>Approval to transfer USDT to contract.</li>
        <li>
          10,000 USDT x
          <select id="num">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>
          in
          <select id="months">
            <option value="3">3</option>
            <option value="6">6</option>
            <option value="7">9</option>
          </select>
          months - <a onclick="deposit()">Stake now</a>
        </li>
        <li>
          Your referral link:
          <a
            id="txtRef"
            onclick="navigator.clipboard.writeText(location.href.replace(location.hash,'')+'#'+$(this).val());$('#status').html('Copied')"
            >Click to copy</a
          >
        </li>
      </ol>
      <h1>Part 3</h1>
      <ol>
        <li>Your packages details - <a onclick="disUser(acct,1)">Here</a></li>
        <ol id="lv1"></ol>
        <li>Your earning history - <a onclick="loadEarnings()">Here</a></li>
        <ol id="history"></ol>
      </ol>
      <h1>Part 4</h1>
      <ol>
        <li>Staking for all <a onclick="stake()">Here</a></li>
      </ol>
      <h1>Part 5</h1>
      <ol>
        <li>Coming soon: LIVE coin price from PanCakeSwap testing</li>
      </ol>
    </div>
  </body>
  <script>
    CHAIN = 4;
    CA = '0xc8a15B7bCeeD2B6B33c80e80Efca5215602ac3C1';
    CA2 = '0x3Dd793f919bf90c4B449DCdEdc650B970F8d9719';
    USDT = '0x8600D030567d4dfA34bB18F650675Df86dC41993';
    _LJS(0);
    async function display() {
      $('#txtRB').html(_R());
      $('#txtRef').val(acct);
      $('#root').show();
      $('#connect').hide();
    }
    async function deposit() {
      oamt = 10000 * $('#num').val() * 1e18;
      amt = oamt.toLocaleString('fullwide', { useGrouping: false });
      if (oamt > balUSDT) {
        $('#status').html('Insufficient USDT');
        return;
      }
      $('#status').html('Approving...');
      await contract3.methods.approve(CA, amt).send(FA);
      $('#status').html('Depositing...');
      await contract.methods.Deposit(_R(), amt, $('#months').val()).send(FA);
      $('#status').html('Deposited Successfully');
      disUSDT();
    }
    async function claim() {
      $('#status').html('Minting...');
      await contract3.methods.MINT(acct).send(FA);
      disUSDT();
      $('#status').html('Minted');
    }
    async function disUSDT() {
      balUSDT = (
        (await contract3.methods.balanceOf(acct).call()) / 1e18
      ).toLocaleString('en-US');
      bal93N = await LB();
      $('#txtUSDT').html(balUSDT);
      $('#txt93N').html(bal93N.toLocaleString('en-US'));
    }
    async function disUser(_acct, _lv) {
      pa = await contract.methods.getUserPackages(_acct).call();
      dl = await contract.methods.getDownlines(_acct).call();
      nl = _lv + 1;
      str = '';
      for (i = 0; i < pa.length; i++)
        str += `<a id='p${pa[i]}'onclick='disPack(${pa[i]})'>[${pa[i]}]</a> `;
      str += '';
      for (i = 0; i < dl[0].length; i++) {
        s = `<li>${dl[0][i].toUpperCase()}</li>`;
        str +=
          _lv < 4
            ? `<a onclick='disUser("${dl[0][i]}",${nl})'>${s}</a><ol id="lv${
                nl + dl[0][i]
              }"></ol>`
            : s;
      }
      $('#lv' + _lv + (_acct == acct ? '' : _acct)).html(str);
    }
    async function disPack(_pa) {
      pa = await contract.methods.Pack(_pa).call();
      $('#p' + _pa).html(
        `[Deposited: ${(pa[1] / 1e18).toLocaleString('en-US')}, Expiry: ${moment
          .unix(pa[4])
          .add(pa[5], 'M')
          .format('D-MMM-YY')}] `
      );
      $('#p' + _pa).addClass('text');
    }
    async function loadEarnings() {
      await contract
        .getPastEvents('Payout', {
          filter: { to: acct },
          fromBlock: 0,
          toBlock: 'latest',
        })
        .then((events) => {
          str = '';
          events.forEach((event) => {
            e = event.returnValues;
            str += `<li>${e.from.toUpperCase()} - ${
              e.status > 1
                ? 'withdrawal'
                : e.status > 0
                ? '93N Staking'
                : 'USDT deposit'
            }: ${(e.amount / 1e18).toLocaleString('en-US')}</li>`;
          });
          $('#history').html(str);
        });
    }
    async function stake() {
      $('#status').html('Staking...');
      await contract.methods.Staking().send(FA);
      $('#status').html('Done');
    }
    window.ethereum.on('accountsChanged', function (accounts) {
      connect();
    });

    async function connect() {
      await load(
        [
          {
            inputs: [],
            name: 'Cleanup',
            outputs: [],
            stateMutability: 'nonpayable',
            type: 'function',
          },
          {
            inputs: [u3, u1, u1],
            name: 'Deposit',
            outputs: [],
            stateMutability: 'nonpayable',
            type: 'function',
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: true,
                internalType: 'address',
                name: 'from',
                type: 'address',
              },
              {
                indexed: true,
                internalType: 'address',
                name: 'to',
                type: 'address',
              },
              {
                indexed: false,
                internalType: 'uint256',
                name: 'amount',
                type: 'uint256',
              },
              {
                indexed: true,
                internalType: 'uint256',
                name: 'status',
                type: 'uint256',
              },
            ],
            name: 'Payout',
            type: 'event',
          },
          {
            inputs: [u1],
            name: 'SetSplit',
            outputs: [],
            stateMutability: 'nonpayable',
            type: 'function',
          },
          {
            inputs: [],
            name: 'Staking',
            outputs: [],
            stateMutability: 'nonpayable',
            type: 'function',
          },
          {
            inputs: [u3],
            name: 'getDownlines',
            outputs: [u4, u1, u1],
            stateMutability: 'view',
            type: 'function',
          },
          {
            inputs: [u3],
            name: 'getUserPackages',
            outputs: [u2],
            stateMutability: 'view',
            type: 'function',
          },
          {
            inputs: [u1],
            name: 'Pack',
            outputs: [u1, u1, u1, u1, u1, u1, u3],
            stateMutability: 'view',
            type: 'function',
          },
        ],
        CA
      );
      await load2();
      contract3 = new web3.eth.Contract(
        [
          {
            inputs: [u3],
            name: 'balanceOf',
            outputs: [u1],
            stateMutability: 'view',
            type: 'function',
          },
          {
            inputs: [u3, u1],
            name: 'approve',
            outputs: [],
            stateMutability: 'nonpayable',
            type: 'function',
          },
          {
            inputs: [u3],
            name: 'MINT',
            outputs: [],
            stateMutability: 'nonpayable',
            type: 'function',
          },
        ],
        USDT
      );
      await disUSDT();
      display();
    }
  </script>
</html>
